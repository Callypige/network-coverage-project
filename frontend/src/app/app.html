<div class="container">
  <h1>🗼 Network Coverage Checker</h1>

  <div class="search-section">
    <div class="autocomplete-wrapper">
      <input
        type="text"
        [value]="address()"
        (input)="onAddressInput($any($event.target).value)"
        (focus)="showSuggestions.set(suggestions().length > 0)"
        placeholder="Tapez au moins 3 lettres pour rechercher une adresse..."
        class="address-input"
        [class.has-selection]="selectedAddress() !== null">

      @if (selectedAddress()) {
        <button class="clear-btn" (click)="clearAddress()" title="Effacer">
          ✕
        </button>
      }

      @if (showSuggestions() && suggestions().length > 0) {
        <div class="suggestions-dropdown">
          @for (suggestion of suggestions(); track suggestion.properties.id) {
            <div class="suggestion-item" (click)="selectSuggestion(suggestion)">
              <div class="suggestion-label">
                📍 {{ suggestion.properties.label }}
              </div>
              <div class="suggestion-context">
                {{ suggestion.properties.context }}
                <span class="suggestion-score">Score: {{ (suggestion.properties.score * 100).toFixed(0) }}%</span>
              </div>
            </div>
          }
        </div>
      }

      @if (showSuggestions() && address().length >= 3 && suggestions().length === 0) {
        <div class="suggestions-dropdown">
          <div class="no-suggestion">
            Aucune adresse trouvée
          </div>
        </div>
      }
    </div>

    <button
      class="search-btn"
      (click)="search()"
      [disabled]="!canSearch()"
      [class.disabled]="!canSearch()">
      {{ loading() ? 'Recherche...' : 'Vérifier la couverture' }}
    </button>
  </div>

  @if (!selectedAddress() && address().length > 0 && address().length < 3) {
    <div class="info-message">
      ℹ️ Tapez au moins 3 caractères pour voir les suggestions
    </div>
  }

  @if (selectedAddress()) {
    @let selected = selectedAddress();
    @if (selected) {
      <div class="selected-address">
        ✅ Adresse sélectionnée : <strong>{{ selected.properties.label }}</strong>
      </div>
    }
  }

  <!-- Results section -->
  <div class="results">
    @if (results()) {
      @let data = results();
      @if (data && data['id1']) {
        <h2>📡 Couverture réseau pour :</h2>
        <p class="address-label">{{ address() }}</p>

        <div class="operators-grid">
          <!-- Orange -->
          <div class="operator-card">
            <h3 class="operator-name orange">Orange</h3>
            <div class="tech-badges">
              <span class="badge" [class.active]="data['id1']['orange']['two_g']">
                2G {{ data['id1']['orange']['two_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['orange']['three_g']">
                3G {{ data['id1']['orange']['three_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['orange']['four_g']">
                4G {{ data['id1']['orange']['four_g'] ? '✓' : '✗' }}
              </span>
            </div>
          </div>

          <!-- SFR -->
          <div class="operator-card">
            <h3 class="operator-name sfr">SFR</h3>
            <div class="tech-badges">
              <span class="badge" [class.active]="data['id1']['SFR']['two_g']">
                2G {{ data['id1']['SFR']['two_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['SFR']['three_g']">
                3G {{ data['id1']['SFR']['three_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['SFR']['four_g']">
                4G {{ data['id1']['SFR']['four_g'] ? '✓' : '✗' }}
              </span>
            </div>
          </div>

          <!-- Bouygues -->
          <div class="operator-card">
            <h3 class="operator-name bouygues">Bouygues</h3>
            <div class="tech-badges">
              <span class="badge" [class.active]="data['id1']['bouygues']['two_g']">
                2G {{ data['id1']['bouygues']['two_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['bouygues']['three_g']">
                3G {{ data['id1']['bouygues']['three_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['bouygues']['four_g']">
                4G {{ data['id1']['bouygues']['four_g'] ? '✓' : '✗' }}
              </span>
            </div>
          </div>

          <!-- Free -->
          <div class="operator-card">
            <h3 class="operator-name free">Free</h3>
            <div class="tech-badges">
              <span class="badge" [class.active]="data['id1']['Free']['two_g']">
                2G {{ data['id1']['Free']['two_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['Free']['three_g']">
                3G {{ data['id1']['Free']['three_g'] ? '✓' : '✗' }}
              </span>
              <span class="badge" [class.active]="data['id1']['Free']['four_g']">
                4G {{ data['id1']['Free']['four_g'] ? '✓' : '✗' }}
              </span>
            </div>
          </div>
        </div>
      }
    }

    @if (!results() && !loading()) {
      <p>Sélectionnez une adresse dans la liste de suggestions puis cliquez sur "Vérifier la couverture"</p>
    }
  </div>
</div>
